<div *ngIf="formLoading()" class="d-flex justify-content-center align-items-center py-5" style="min-height: 300px;">
  <c-spinner size="lg" variant="grow" color="primary"></c-spinner>
</div>

<c-card class="p-3 shadow" *ngIf="!formLoading()">
<form
  cForm
  class="pb-2"
  [formGroup]="visitForm"
  (ngSubmit)="addVisit()"
>
  <c-row class="g-3 flex-wrap align-items-center mb-3">
    <c-col xs="12" xl="4" class="d-flex align-items-center flex-wrap me-4">
      <c-input-group class="">
         <span cInputGroupText class="d-flex align-items-center flex-shrink-0 mb-2 mb-md-0">
      <svg
        class="me-2"
        [cIcon]="icons.cilCalendar"
        size="lg"
        title="List Icon"
      ></svg>
      تاريخ الزيارة
    </span>
        <c-date-picker
          placeholder="اختر التاريخ"
          class="w-50"
          [locale]="'ar'"
          dir="rtl"
          formControlName="visitDate"
          [minDate]="minDate"
          [maxDate]="maxDate"
        />
      </c-input-group>
    </c-col>
  </c-row>
  
  <c-row class=" flex-wrap align-items-center">
    <hr />
    <c-col
      xs="10"
      xl="3"
      md="5"
      lg="5"
      sm="6"
      class="d-flex align-items-center flex-wrap me-4 mt-2 "
    >
         <label cLabel>
          <svg
            class="me-1"
            [cIcon]="icons.cilUser"
            size="lg"
            title="List Icon"
          ></svg>
          اسم الطبيب
        </label>

         <select
          aria-label="Default select example"
          cSelect
          formControlName="doctorId"
        >
          <option [ngValue]="null">اختر الطبيب</option>
         @for(doctor of visitFormData?.doctors; track doctor.id) {
          <option [ngValue]="doctor.id">{{ doctor.value }}</option>
          }
        </select>
    </c-col>

    <c-col
      xs="10"
      xl="3"
      md="5"
      lg="5"
      sm="6"
      class="d-flex align-items-center flex-wrap mt-2 "
    >
         <label cLabel>
          <svg
            class="me-1"
            [cIcon]="icons.cilBuilding"
            size="lg"
            title="List Icon"
          ></svg>
          اسم العيادة
        </label>

         <select
          aria-label="Default select example"
          cSelect
          formControlName="organizationId"
        >
          <option [value]="null">اختر العيادة</option>
         @for(org of visitFormData?.organizations; track org.id) {
          <option [value]="org.id">{{ org.value }}</option>
          }
        </select>
    </c-col>
</c-row>

  <div formArrayName="productBlocks">
    <div
      *ngFor="let block of productBlocks.controls; let i = index"
      [formGroupName]="i"
    >
      <hr />

      <!-- Product + Sample -->
      <c-row class="mb-2 ">
        <!-- Product -->
        <c-col xs="10" xl="4" class ="ml-3 mt-2">
             <label cLabel>
          <svg
            class="me-1"
            [cIcon]="icons.cilMedicalCross"
            size="lg"
            title="List Icon"
          ></svg>
          الدواء
        </label>
            <select cSelect formControlName="productId">
               <option [value]="null">اختر الدواء</option>
              @for(product of visitFormData?.products; track product.id) {
              <option [value]="product.id">{{ product.name }}</option>
              }
            </select>
        </c-col>

        <c-col xs="10" xl="4" class="mt-2">
               <label cLabel>
          <svg
            class="me-1"
            [cIcon]="icons.cilEnvelopeClosed"
            size="lg"
            title="List Icon"
          ></svg>
          الرسالة
        </label>
            <select cSelect formControlName="messageId">
              <option [value]="null">اختر الرسالة</option>
              @for(message of block.get('availableMessages').value; track message.id)
              {
                <option [value]="message.id">{{ message.value }}</option>
              }
            </select>
        </c-col>
      </c-row>

      <c-row class="mt-3 mb-2">
        <c-col xs="10" xl="3">
           <label cLabel>
          <svg
            class="me-1"
            [cIcon]="icons.cilAlignCenter"
            size="lg"
            title="List Icon"
          ></svg>
          عدد العينات
        </label>
            <input
              cFormControl
              type="number"
              formControlName="samples"
              placeholder="0"
            />
        </c-col>
      </c-row>

      <!-- Add/Remove Product Buttons -->
      <c-row class="mt-3">
        <c-col>
          <button
            *ngIf="i === productBlocks.length - 1 && productBlocks.length < 3"
            cButton
            color="success"
            class="me-2 text-light fw-bold"
            (click)="addProductBlock()"
          >
            + منتج آخر
          </button>
          <button
            *ngIf="productBlocks.length > 1"
            cButton
            color="danger"
            class="text-light fw-bold"
            (click)="removeProductBlock(i)"
          >
            - حذف المنتج
          </button>
        </c-col>
      </c-row>
    </div>
  </div>

  <c-row class="g-3 mt-1 flex-wrap align-items-center">
    <hr />
    <c-col
      xs="12"
      xl="4"
      class="d-flex align-items-center flex-wrap"
      class="w-75"
    >
     <div class="d-flex align-items-start mx-2">
  <c-form-check sizing="xl" switch class="mb-0">
    <input
      cFormCheckInput
      type="checkbox"
      formControlName="hasSupervisor"
      value="true"
    />
  </c-form-check>
  <label
    cFormCheckLabel
    class="mb-0 ms-2 text-wrap checkBoxLabel"
  >
    هل كانت الزيارة بصحبة مشرف ؟
  </label>
</div>

    </c-col>
  </c-row>

  <c-row class="g-3 mt-1 flex-wrap align-items-center">
    <c-col
      xs="12"
      xl="4"
      class="d-flex align-items-center flex-wrap"
      class="w-75"
    >
        <label cLabel>
          <svg
            class="me-1"
            [cIcon]="icons.cilDescription"
            size="lg"
            title="List Icon"
          ></svg>
          ملاحظات
        </label>
      <textarea
        cFormControl
        placeholder=" أضف أي ملاحظات إضافية هنا ..."
        rows="3"
        formControlName="notes"
      ></textarea>
    </c-col>
  </c-row>

<c-row class="mt-4">
  <c-col xs="12">
    <button
      cButton
      color="primary"
      size="md"
      type="submit"
      class="col-12 d-flex align-items-center justify-content-center"
    >
      <svg
        [cIcon]="icons.cilSave"
        class="me-2 align-middle"
        size="xl"
        title="Save Icon"
      ></svg>
      <span class="align-middle">تسجيل زيارة</span>
    </button>
  </c-col>
</c-row>

</form>
</c-card>